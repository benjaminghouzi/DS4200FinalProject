<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Interactive Coffee Sankey</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background: #fafafa;
      }
      .node rect {
        cursor: pointer;
      }
      .link {
        fill: none;
        stroke-opacity: 0.35;
        transition: 0.2s;
      }
      .link:hover {
        stroke-opacity: 0.7;
      }
      .tooltip {
        position: absolute;
        padding: 6px 10px;
        background: #333;
        color: white;
        font-size: 12px;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
        transition: 0.15s;
      }
    </style>
  </head>
  <body>
    <h2>Interactive Sankey Diagram — Time of Day → Coffee Type</h2>
    <div id="chart"></div>

    <div class="tooltip" id="tooltip"></div>

    <script>
      const width = 900,
        height = 500;

      const svg = d3
        .select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const tooltip = d3.select("#tooltip");

      d3.csv("./Coffe_sales.csv").then((data) => {
        // Aggregate flows: Time_of_Day → coffee_name
        const flow = d3
          .rollups(
            data,
            (v) => d3.sum(v, (d) => +d.money),
            (d) => d.Time_of_Day,
            (d) => d.coffee_name
          )
          .flatMap(([time, coffees]) =>
            coffees.map(([coffee, money]) => ({
              source: time,
              target: coffee,
              value: money,
            }))
          );

        // Unique nodes
        const nodes = Array.from(
          new Set(flow.flatMap((d) => [d.source, d.target])),
          (name) => ({ name })
        );

        // Convert node names to indices
        const nameToIndex = Object.fromEntries(
          nodes.map((d, i) => [d.name, i])
        );
        const links = flow.map((d) => ({
          source: nameToIndex[d.source],
          target: nameToIndex[d.target],
          value: d.value,
        }));

        const sankey = d3
          .sankey()
          .nodeWidth(20)
          .nodePadding(15)
          .extent([
            [1, 1],
            [width - 1, height - 6],
          ]);

        const graph = sankey({
          nodes: nodes.map((d) => ({ ...d })),
          links: links.map((d) => ({ ...d })),
        });

        // Color scale for nodes
        const color = d3
          .scaleOrdinal()
          .domain(nodes.map((d) => d.name))
          .range(d3.schemeSet2);

        // Draw links
        svg
          .append("g")
          .selectAll("path")
          .data(graph.links)
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("d", d3.sankeyLinkHorizontal())
          .attr("stroke", (d) => color(nodes[d.source.index].name))
          .attr("stroke-width", (d) => d.width)
          .on("mousemove", (event, d) => {
            tooltip
              .style("opacity", 1)
              .text(
                `${nodes[d.source.index].name} → ${
                  nodes[d.target.index].name
                }: $${d.value.toFixed(2)}`
              )
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY + 10 + "px");
          })
          .on("mouseleave", () => tooltip.style("opacity", 0));

        // Draw nodes
        const node = svg
          .append("g")
          .selectAll("g")
          .data(graph.nodes)
          .enter()
          .append("g")
          .attr("class", "node");

        node
          .append("rect")
          .attr("x", (d) => d.x0)
          .attr("y", (d) => d.y0)
          .attr("height", (d) => d.y1 - d.y0)
          .attr("width", (d) => d.x1 - d.x0)
          .attr("fill", (d) => color(d.name))
          .on("mousemove", (event, d) => {
            tooltip
              .style("opacity", 1)
              .text(`${d.name}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY + 10 + "px");
          })
          .on("mouseleave", () => tooltip.style("opacity", 0));

        node
          .append("text")
          .attr("x", (d) => d.x0 - 6)
          .attr("y", (d) => (d.y0 + d.y1) / 2)
          .attr("text-anchor", "end")
          .attr("dominant-baseline", "middle")
          .text((d) => d.name)
          .style("font-size", "13px");
      });
    </script>
  </body>
</html>
